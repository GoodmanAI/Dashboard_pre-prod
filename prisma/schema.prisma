datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum Role {
  ADMIN
  CLIENT
}

enum CentreRole {
  ADMIN_USER
  USER
}

enum TicketStatus {
  PENDING
  IN_PROGRESS
  CLOSED
}

enum CallIntent {
  RDV
  INFO
  URGENCE
  ANNULATION
  CONSULTATION
}

enum CallStatus {
  COMPLETED
  ABANDONED
  TRANSFERRED
}

model User {
  id         Int         @id @default(autoincrement())
  name       String?
  email      String      @unique
  password   String
  role       Role        @default(CLIENT)
  centreRole CentreRole?

  managerId    Int?
  manager      User?  @relation("UserManager", fields: [managerId], references: [id], onDelete: Cascade)
  managedUsers User[] @relation("UserManager")

  address    String?
  city       String?
  postalCode String?
  country    String?

  userProducts   UserProduct[]
  userNumbers    UserNumber[]
  tickets        Ticket[]         @relation("TicketForUser")
  notifications  Notification[]
  FileSubmission FileSubmission[]
  calls          Call[]           @relation("CallForUser")
  createdTickets Ticket[]         @relation("TicketCreatedBy")
  createdCalls   Call[]           @relation("CallCreatedBy")

  // ðŸ‘‡ this must match the name in ReceivedCalls.center
  receivedCallsAsCenter ReceivedCalls[] @relation("ReceivedCallsCenter")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Product {
  id             Int              @id @default(autoincrement())
  name           String           @unique
  description    String?
  userProducts   UserProduct[]
  FileSubmission FileSubmission[]
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
}

model UserProduct {
  id         Int       @id @default(autoincrement())
  userId     Int
  productId  Int
  assignedAt DateTime  @default(now())
  removedAt  DateTime?

  explainDetails LyraeExplainDetails?
  talkDetails    LyraeTalkDetails?

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  product      Product       @relation(fields: [productId], references: [id], onDelete: Cascade)
  TalkSettings TalkSettings?

  // ðŸ‘‡ Relation back to ReceivedCalls
  receivedCalls       ReceivedCalls[]          @relation("UserProductReceivedCalls")
  informationSettings TalkInformationSettings? @relation("TalkInformationSettingsRelation")
  examMappings        ExamMapping[]

  @@unique([userId, productId])
}

model UserNumber {
  id         Int       @id @default(autoincrement())
  userId     Int
  number     String    @unique
  assignedAt DateTime  @default(now())
  removedAt  DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model LyraeExplainDetails {
  id               Int       @id @default(autoincrement())
  userProductId    Int       @unique
  metricsByMonth   Json      @default("[]")
  commentsByMonth  Json      @default("[]")
  metricsUpdatedAt DateTime?

  userProduct UserProduct @relation(fields: [userProductId], references: [id], onDelete: Cascade)
}

model LyraeTalkDetails {
  id                   Int      @id @default(autoincrement())
  userProductId        Int      @unique
  talkInfoValidated    Boolean? @default(false)
  talkLibelesValidated Boolean? @default(false)

  userProduct UserProduct @relation(fields: [userProductId], references: [id], onDelete: Cascade)
}

model FileSubmission {
  id        Int      @id @default(autoincrement())
  userId    Int
  productId Int
  fileName  String
  fileUrl   String
  createdAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
}

model Ticket {
  id          Int  @id @default(autoincrement())
  userId      Int
  createdById Int?

  subject   String
  message   String
  status    TicketStatus @default(PENDING)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  user          User           @relation("TicketForUser", fields: [userId], references: [id], onDelete: Cascade)
  createdBy     User?          @relation("TicketCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  notifications Notification[]
}

model Notification {
  id        Int      @id @default(autoincrement())
  ticketId  Int?
  userId    Int
  message   String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  ticket Ticket? @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Call {
  id          Int  @id @default(autoincrement())
  userId      Int
  createdById Int?

  caller String
  called String

  intent String? // ex: "prise de rdv" | "info" | "urgence" | "annulation" | "consultation"

  intentCode  CallIntent?
  status      CallStatus  @default(COMPLETED)
  durationSec Int         @default(0)

  firstname String?
  lastname  String?
  birthdate DateTime?
  createdAt DateTime  @default(now())
  steps     String[]

  user      User  @relation("CallForUser", fields: [userId], references: [id], onDelete: Cascade)
  createdBy User? @relation("CallCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
}

model TalkSettings {
  id            Int @id @default(autoincrement())
  userProductId Int @unique

  voice               String?
  botName             String?
  welcomeMsg          String?
  emergencyOutOfHours String?
  callMode            String?

  fullPlanningNotes Json  @default("{}")
  examsAccepted     Json? @default("{}")
  examQuestions     Json? @default("{}")

  // ðŸ†• all your exam rows stored here
  exams Json @default("[]")

  // ðŸ†• consignes diffÃ©renciÃ©es par modalitÃ© d'examen
  examInstructions Json? @default("{}")

  specificNotes  String?
  reconnaissance Boolean  @default(false)
  updatedAt      DateTime @updatedAt

  userProduct UserProduct @relation(fields: [userProductId], references: [id], onDelete: Cascade)
}

model ReceivedCalls {
  id            Int      @id @default(autoincrement())
  userProductId Int
  centerId      Int
  createdAt     DateTime @default(now())

  // ðŸ‘‡ Must use the same relation name
  userProduct UserProduct @relation("UserProductReceivedCalls", fields: [userProductId], references: [id], onDelete: Cascade)

  // Relation to User (center)
  center User @relation("ReceivedCallsCenter", fields: [centerId], references: [id], onDelete: Cascade)
}

model TalkInformationSettings {
  id            Int      @id @default(autoincrement())
  userProductId Int      @unique
  data          Json     @default("{}")
  updatedAt     DateTime @updatedAt
  createdAt     DateTime @default(now())
  weeklyHours   Json?    @default("{}")

  userProduct UserProduct @relation("TalkInformationSettingsRelation", fields: [userProductId], references: [id], onDelete: Cascade)
}

model ExamMapping {
  id            Int    @id @default(autoincrement())
  userProductId Int
  examCode      String
  labelFr       String
  diminutif     String

  userProduct UserProduct @relation(fields: [userProductId], references: [id], onDelete: Cascade)

  @@unique([userProductId, examCode])
}

model CallConversation {
  id            Int      @id @default(autoincrement())
  userProductId Int
  centerId      Int
  steps         Json     @default("{}")
  stats         Json     @default("{}")
  createdAt     DateTime @default(now())

  userProduct UserProduct @relation(fields: [userProductId], references: [id], onDelete: Cascade)
}
